<link rel="import" href="../iron-form/iron-form.html">

<dom-module id="callback-form">
    <template>
        <style>
            :host { display: block; }
        </style>
        <iron-form id="callbackForm">
            <slot></slot>
        </iron-form>
    </template>
    <script>
        Polymer({
            is: 'callback-form',
            properties: {
                errorMessage: {
                    type: String,
                    value: 'Произошла ошибка. Попробуйте отправить вашу заявку позднее.'
                },
                submitMessage: {
                    type: String,
                    value: 'Заявка успешно отправлена!'
                },
                submitBtn: Object,
                display: Object,
                formData: Object
            },
            ready: function () {
                this.submitBtn = this.querySelector('[type="submit"]');
                // noinspection EqualityComparisonWithCoercionJS
                if (this.submitBtn == null)
                    this.submitBtn = this.querySelector('button:not([type="button"])');

                // noinspection EqualityComparisonWithCoercionJS
                if (this.submitBtn == null)
                    console.error("Can't find submit button");
                else
                    this.display = this.submitBtn.parentNode;

                this.listen(this.$.callbackForm, 'iron-form-submit', 'onSubmit');
                this.listen(this.$.callbackForm, 'iron-form-error', 'onError');
                this.listen(this.$.callbackForm, 'iron-form-response', 'onResponse');
            },
            onSubmit: function () {
                var i, input, len, ref;
                this.formData = this.$.callbackForm.serializeForm();
                this.submitBtn.textContent = this.submitBtn.getAttribute('data-loading-text');
                ref = this.querySelectorAll('[name]');
                for (i = 0, len = ref.length; i < len; i++) {
                    input = ref[i];
                    if (this.isLightDescendant(input)) {
                        input.disabled = true;
                    }
                }
                this.submitBtn.disabled = true;
            },
            onError: function () {
                this.prepareForMessage();
                this.display.textContent = this.errorMessage;
                this.toggleClass('alert-danger', true, this.display);
                this.fire('callback-form-sending-error', {
                    formData: this.formData
                });
            },
            onResponse: function (e) {
                this.prepareForMessage();
                if (e.detail.response && e.detail.response.message)
                    this.submitMessage = e.detail.response.message;
                this.display.textContent = this.submitMessage;
                this.toggleClass('alert-success', true, this.display);
                this.fire('callback-form-sending-success', {
                    formData: this.formData
                });
            },
            prepareForMessage: function () {
                this.display.removeChild(this.submitBtn);
                this.toggleClass('alert', true, this.display);
            },
            submit: function () {
                this.$.callbackForm.submit();
            }
        });
    </script>
</dom-module>